<html>
    <body>
        <h1>Test events</h1>
        <div>
            <button id="btnAddLesson" onclick="addElementToStage(stage, 'Lesson')">Add Lesson</button>
            <button id="btnAddQuiz" onclick="addElementToStage(stage, 'Quiz')">Add Quiz</button>
        </div>
        <div><canvas id="stage" width="800" height="600" style="border: 1px; background: #f3fff2;"></canvas></div>


        <script>
            class Element {
                static cnt = 0;
                         
                constructor (type="Default", x, y) {
                    this.type = type;
                    this.x = x;
                    this.y = y;
                    
                    this.w = 96
                    this.h = 40

                    this.id = Element.cnt; // TODO we should use more smart way to generate element id's
                    Element.cnt += 1;
                    this.name = String(this.type) + " " + String(this.id);
                    
                  //ports

                    if (type == "Start") {
                        this.w = 40
                        this.h = 40
                        this.port_in = null;
                        this.port_out = new Port(this, "OUT", 14, 28, 12, 12);

                    } else {
                        this.port_in = new Port(this, "IN", 40, 0, 12, 12);
                        this.port_out = new Port(this, "OUT", 40, 28, 12, 12);
                    }
                }

                draw(ctx) {

                    if (this.type == "Start") {
                        ctx.fillStyle = "#f0fff0";
                        ctx.strokeStyle = "#CCCCCC";
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.arc(this.x + this.w/2, this.y+ this.h/2, 20, 0, Math.PI*2);
                        ctx.closePath();
                        ctx.stroke();
                        ctx.fill();

                    } else {
                    
                        ctx.fillStyle = "#FFFFFF";
                        ctx.lineWidth = 1;
                        ctx.fillRect(this.x, this.y, this.w, this.h);
                        
                        ctx.rect(this.x, this.y, this.w, this.h);
                        ctx.moveTo(this.x, this.y + 12);
                        ctx.lineTo(this.x + this.w, this.y + 12);
                        
                        ctx.moveTo(this.x, this.y + this.h - 12);
                        ctx.lineTo(this.x + this.w, this.y + this.h - 12);
                        ctx.strokeStyle = "#333333";
                        ctx.stroke();
                    }    
                        ctx.fillStyle = "#000000";
                        ctx.font = "10px Arial";
                        ctx.fillText(this.name, this.x + 6, this.y + 24, this.w - 12);

                        if (this.port_in) {
                            this.port_in.draw(ctx);
                        }
                        if (this.port_out) {
                            this.port_out.draw(ctx);
                        }
                    
                }

                highlight(ctx){
                    ctx.fillStyle = "#FFFF66";
                    ctx.strokeRect(this.x, this.y, this.w, this.h);
                }
                
                moveTo(x,y){
                    this.x = x;
                    this.y = y;
                }

                getPortByXY(x, y) {
                    if (this.port_in) {
                        let port = this.port_in;
                        let px = this.x + port.dx;
                        let py = this.y + port.dy;
                        let pw = port.w;
                        let ph = port.h;
                        
                        if (x >= px  && x < px +pw && y >= py && y < py + ph) {
                            return port;
                        }
                                           
                    }
                    if (this.port_out) {
                        let port = this.port_out;
                        let px = this.x + port.dx;
                        let py = this.y + port.dy;
                        let pw = port.w;
                        let ph = port.h;
                        
                        if (x >= px  && x < px +pw && y >= py && y < py + ph) {
                            return port;
                        }
                                           
                    }
                    return null;
                }

            }

            class Port {
                constructor(el, type, dx, dy, w, h){
                    this.el = el;
                    this.type = type;
                    this.dx = dx;
                    this.dy = dy;
                    this.w = w;
                    this.h = h;
                }

                draw(ctx) {
                    if (this.type == "IN") {
                        ctx.fillStyle = "#FF9999";    
                    } else {
                        ctx.fillStyle  = "#9999FF";
                    }
                    let x1 = this.el.x + this.dx;
                    let y1 = this.el.y + this.dy;
                    let x2 = x1 + this.w;
                    let y2 = y1 + this.h;
                    
                    
                    //ctx.fillRect (this.el.x + this.dx, this.el.y + this.dy, this.w, this.h);
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y1);
                    ctx.lineTo((x1 + x2)/2, y2);
                    ctx.closePath();
                    ctx.fill();
                    
                }
            }

            class Connector {
                constructor (port){
                    this.start_x = port.el.x + port.dx;
                    this.start_y = port.el.y + port.dy;
                    this.end_x = this.start_x;
                    this.end_y = this.start_y;
                    
                }

                expandTo(x, y) {
                    this.end_x = x;
                    this.end_y = y;
                }

                draw(ctx) {
                    ctx.strokeStyle = "#000000";
                    ctx.beginPath();
                    ctx.moveTo(this.start_x, this.start_y);
                    ctx.bezierCurveTo(this.start_x, this.start_y + 100, this.end_x, this.end_y -100, this.end_x, this.end_y);
                    ctx.stroke();
                   
                }

            }

            class Stage {
                constructor (canvas){
                    this.stage_canvas = canvas;
                    this.ctx = canvas.getContext("2d");
                    this.ctx_width = canvas.getAttribute("width");
                    this.ctx_height = canvas.getAttribute("height");
                    this.elements = new Array();
                    this.mode = "IDLE";
                    
                }

                clearAll(){
                    this.ctx.clearRect(0, 0, this.ctx_width, this.ctx_height);
                }

                drawAll(){
                    for (let i = 0; i < this.elements.length; i++) {
                        this.elements[i].draw(this.ctx);
                    }

                }

                setCursor(cur){
                    this.stage_canvas.style.cursor = cur;
                }

                addElement(el){
                    this.elements.push(el);
                    el.draw(this.ctx);
                }

                getElementByXY(x,y){
                    for (let i = this.elements.length - 1; i >= 0; i--) { //the last element is on the top  
                        let el =  this.elements[i];
                        if (x >= el.x && x < el.x + el.w && y >= el.y && y < el.y + el.h){ // click within element's rectangle
                            return el;
                        }
                    }
                    return null;
                }      

                stageMouseDown(e){
                    
                    let x = e.offsetX;
                    let y = e.offsetY;
                
                                 
                    if (this.mode == "ADD_ELEMENT") {
                        let el = new Element(this.el_type, x, y);
                        this.addElement(el);
                        
                        this.mode = "IDLE";

                    } else {    

                        let el = this.getElementByXY(x,y);
                      
                        
                        if (el) {
                            el.highlight(this.ctx);

                            let port = el.getPortByXY(x,y);

                            if (port) {
                                if (port.type == "OUT") {
                                    this.mode = "ADD_CONNECTOR";
                                    this.active_connector = new Connector(port);
                                    this.setCursor("pointer");
                                }
                            } else {

                                this.mode = "MOVE_ELEMENT";
                                this.setCursor("move");
                                this.active_el = el;
                                this.active_dx = el.x - x;
                                this.active_dy = el.y - y;
                            }

                        } else {

                            is_draw = true;
                            this.ctx.fillStyle = "#0099FF";
                            this.ctx.fillRect(x - 5, y - 5, 10, 10);
                        }
                    }
                }

                stageMouseUp(e){
                    let x = e.offsetX;
                    let y = e.offsetY;

                    if(this.mode == "MOVE_ELEMENT"){
                        this.active_el.moveTo(x + this.active_dx, y + this.active_dy);
                        this.clearAll();
                        this.drawAll();
                        this.mode = "IDLE";
                    } else if (this.mode == "ADD_CONNECTOR") {
              
                        this.active_connector.expandTo(x,y);
              

                        this.active_connector.draw(this.ctx);
                        this.mode = "IDLE";
                    }

                    this.ctx.shadowOffsetX = 0;
                    this.ctx.shadowOffsetY = 0;
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    this.ctx.fillStyle = "red";
                    this.ctx.fill();


                    
                }

                stageMouseMove(e){
                    let x = e.offsetX;
                    let y = e.offsetY;
/*
                    this.ctx.beginPath();
                    this.ctx.moveTo(x,y);
                    this.ctx.lineTo(x+1, y+1);
                    this.ctx.stroke();
*/
                    }

            }

            function addElementToStage(stage, type){
                stage.mode = "ADD_ELEMENT";
                stage.el_type = type;
                stage.setCursor("move");
            }

            function myEventHandlerMouseDown(e){
                stage.stageMouseDown(e);
            }

            function myEventHandlerMouseUp(e){
                stage.setCursor("default");
                stage.stageMouseUp(e);
            }

            function myEventHandlerMouseMove(e){
                stage.stageMouseMove(e);
            }

            const stage_canvas = document.getElementById("stage")
            const stage = new Stage(stage_canvas);

            let start_el = new Element("Start", 50,50);
            stage.addElement(start_el);
            stage.drawAll();
            
            // TODO toolbar
            const btnAddElement = document.getElementById("btnAddElement");

            let is_draw = false;
            let mode = "IDLE";
            let start_x = 0; 
            let start_y = 0;     
            let finish_x = 0; 
            let finish_y = 0;

            stage_canvas.addEventListener("mousedown", myEventHandlerMouseDown);
            stage_canvas.addEventListener("mouseup", myEventHandlerMouseUp);
            stage_canvas.addEventListener("mousemove", myEventHandlerMouseMove);

            

        </script>
    </body>
</html>